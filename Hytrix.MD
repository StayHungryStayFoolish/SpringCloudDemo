# Hystrix 服务容错保护系统

## 三大特性

- 服务降级

    - 当服务消费方触发了服务请求超时的异常，服务消费者通过 @HystrixCommand 注解中的 fallBack(后备)
      内指定的方法名称，来执行降级。

- 依赖隔离

    - Hystrix 使用的 `舱壁模式` ，实现了对 `线程池` 的隔离，该模式会为每一个 Hystrix
      命令创建一个独立的线程池。

      所以单个的 Hystrix 命令包装下的依赖服务如果延迟过高，只会影响当前服务，不会
      拖慢其他服务。

    - 优势

      - 应用自身得到完全保护，不会受不可控的依赖服务影响。

      - 有效降低接入新服务的风险。

      - 依赖服务从失效到恢复正常后，线程池会被清理并马上恢复健康的服务。比容器速度快。

      - 依赖服务出现配置错误的时候，线程池会迅速反映出此问题（通过失败次数、延迟、超时、
        拒绝等指标增加情况）。

      - 当依赖服务实现机制调整等原因造成其性能出现较大变化时，线程池监控指标信息会反应
        出这样的变化。

      - 实时动态刷新。

      - 每个线程池都提供了内置的并发实现，可以利用发为同步的依赖服务构建异步的访问。

    - 通过依赖隔离，配合动态配置刷新可以实现在不停止服务的情况下，进行调整。使得应用更加灵活。

    - **并发度的控制** ：Hystrix 除了内置的线程池外，还可以使用 `信号量` 来控制单个依赖服务的并发度
      线程池的并发（隔离线程池延迟9 ms）带来了额外的开销。因此使用 `信号量`来控制单个依赖
      服务的并发度，但`信号量`不能设置超时和异步访问。只有在依赖服务足够可靠的情况下才使用
      `信号量`。 HystrixCommand 和 HystrixObservableCommand 支持`信号量`使用

      - 命令执行：如果隔离策略参数 execution.isolation.strategy 设置为 SEMAPHORE，
        Hystrix 会使用信号量来替代线程池来控制依赖服务的并发控制。

      - 降级逻辑：当 Hystrix 尝试降级逻辑的时候，它会在调用线程中使用信号量。

      - 信号量默认值为 10，可以通过动态刷新配置方式来控制并发线程数量。

        对仅访问内存数据的请求一般好事在 1ms 以内，性能达到 5000rps。这样级别的请求
        我们将信号量设置为1或者2，按照此标准根据实际请求耗时来设置信号量。

- 断路器

    - `断路器` 本身是一种开关装置。用于在线路上保护线路过载，当线路中有电器发生短路时，
      `断路器`能及时切断故障电路，防止发生过载、发热甚至起火等严重后果。

    - 分布式架构中，断路器模式的作用也是类似的。当某个服务单元发生故障（类似电器发生短路）
      之后，通过断路器故障监控（类似熔断保险丝），直接切断原来的主逻辑调用。

    - 当前项目的 Eureka-Client 中，加入了模拟时间延迟 Thread.Sleep(5000L);
      当服务消费的的服务降级逻辑因为 @HystrixCommand 命令调用依赖服务超时，触发了降级逻辑。
      即使这样，受限于 Hystrix 超时时间的问题，调用依然很有可能产生堆积。

      这个时候，断路器就会发挥作用。

    - **断路器三个重要参数**

      - **快照时间窗** -- 断路器确定是否打开需要统计一些请求和错误数据，统计时间就是快照时间窗，`默认为最近的10秒`。

      - **请求总数下线** -- 在快照时间窗内，必须满足请求总是下限才有资格熔断。`默认为20。`
        意味着在 `10` 秒内，如果该 hystrix 命令的调用此时不足 `20次`，即时所有的请求都超时
        或其他原因失败，断路器都不会打开。如果 `超过20次` 会打开断路器模式。

      - **错误百分比下限** -- 当请求总是在快照时间窗内超过了下限，比如发生了 `30次调用`，如果
        这30次调用，有 `16次发生了超时异常` ，也就是超过 50% 错误百分之比，在 `默认设定 50% `下限情况下，
        这是就会将断路器打开。

    - **断路器打开后**，如果断路器打开后，再有请求调用的时候，将不会调用主逻辑，而是直接
      调用 `降级逻辑`，这个时候不会等待项目中设置的 `5秒`之后再返回 String 。而是直接返回。
      `通过断路器，实现了自动发现错误并将降级逻辑切换主逻辑，减少响应延迟小伙`

    — **断路启动后，原主逻辑恢复问题**  Hystrix 实现了自动回复功能。当断路器打开，对主逻辑
      熔断后，Hystrix 会启动一个 `休眠时间窗` ，在这个时间窗内，如果此请求正常翻倍，断路器
      将闭合，主逻辑恢复。如果请求依然偶问题，继续打开断路器状态，休眠时间窗重新及时。

Hystrix 通过上面一系列机制，实现了对依赖资源故障的端口、对降级策略的自动切换、对主逻辑
自动回复机制。使得微服务在依赖外部服务或资源的时候，得到了很好保护，同时对一些具备降级业务需求可以实现自动切换与回复，
相比于设置开关由监控和原味来进行切换的传统实现方式更为智能和高效。